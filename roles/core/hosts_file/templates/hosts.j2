#jinja2: lstrip_blocks: "True"

{% import "macros/network.j2" as macro_network with context %}
{% import "macros/accelerated.j2" as macro_accelerated with context %}


{# Macro to avoid redundancy #}
{% macro write_host(host) %}
  {% if hostvars[host]['network_interfaces'] is defined and not none %}{# These part are clone #}
    {% set alias_list = [] %}
    {% if hostvars[host]['global_alias'] is defined and not none %}
      {% for alias in hostvars[host]['global_alias'] %}{{ alias_list.append(alias) }}{% endfor %}
    {% endif %}
    {% if hostvars[host]['alias'] is defined and not none and hostvars[host]['j2_current_iceberg'] == j2_current_iceberg %}
      {% for alias in hostvars[host]['alias'] %}{{ alias_list.append(alias) }}{% endfor %}
    {% endif %}
    {% for interface, interface_vars in hostvars[host]['network_interfaces'].items() %}
      {% if interface_vars.ip4 is defined and not none and interface_vars.network is defined and not none %}
        {% if (global_network_settings is defined and not none) and (global_network_settings.enable_global_network is defined and not none) and (global_network_settings.global_network_group is defined and not none) and (host in groups[global_network_settings.global_network_group]) %}
          {% if interface_vars.network == global_network_settings.global_network %}
{{interface_vars.ip4}} {{host}} {{host}}.{{domain_name}} {{host}}-{{interface_vars.network}} {{alias_list|join(' ')}}
          {% else %}
{{interface_vars.ip4}} {{host}}-{{interface_vars.network}}
          {% endif %}
        {% else %}
          {% if interface == hostvars[host]['j2_node_main_network_interface'] %}
{{interface_vars.ip4}} {{host}} {{host}}.{{domain_name}} {{host}}-{{interface_vars.network}} {{alias_list|join(' ')}}
          {% else %}
{{interface_vars.ip4}} {{host}}-{{interface_vars.network}}
          {% endif %}
        {% endif %}
      {% endif %}
    {% endfor %}
    {% if hostvars[host]['bmc'] is defined %}
      {% set bmc_args = hostvars[host]['bmc'] %}
      {% if (bmc_args.name is defined and not none) and (bmc_args.ip4 is defined and not none) %}
{{bmc_args.ip4}} {{bmc_args.name}}
      {% endif %}
    {% endif %}
  {% endif %}
{% endmacro %}

{% macro write_host_2(host,host_nic,host_node_main_network_interface,alias_list,host_bmc) %}
  {% for interface, interface_vars in host_nic.items() %}
    {% if interface_vars.ip4 is defined and not none and interface_vars.network is defined and not none %}
      {% if (global_network_settings is defined and not none) and (global_network_settings.enable_global_network is defined and not none) and (global_network_settings.global_network_group is defined and not none) and (host in groups[global_network_settings.global_network_group]) %}
        {% if interface_vars.network == global_network_settings.global_network %}
{{interface_vars.ip4}} {{host}} {{host}}.{{domain_name}} {{host}}-{{interface_vars.network}} {{alias_list|join(' ')}}
        {% else %}
{{interface_vars.ip4}} {{host}}-{{interface_vars.network}}
        {% endif %}
      {% else %}
        {% if interface == host_node_main_network_interface %}
{{interface_vars.ip4}} {{host}} {{host}}.{{domain_name}} {{host}}-{{interface_vars.network}} {{alias_list|join(' ')}}
        {% else %}
{{interface_vars.ip4}} {{host}}-{{interface_vars.network}}
        {% endif %}
      {% endif %}
    {% endif %}
  {% endfor %}
  {% if host_bmc is defined and host_bmc is not none %}
    {% if (host_bmc.name is defined and not none) and (host_bmc.ip4 is defined and not none) %}
 {{host_bmc.ip4}} {{host_bmc.name}}
    {% endif %}
  {% endif %}

{% endmacro %}


#### Blue Banquise file ####
## {{ansible_managed}}

127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6

{% if icebergs_system == true and hosts_file['range'] == 'iceberg' %}
{% set range = groups[j2_current_iceberg] %}
{% for host in groups[managements_group_name] %}
{% if hostvars[host]['iceberg_master'] == j2_current_iceberg %}
{{ range.append(host) }}
{% endif %}
{% endfor %}
{% else %}
{% set range = groups['all'] %}
{% endif %}

## Internal hosts
{#
{% for host in range %}
{% set alias_list = [] %}
{% if hostvars[host]['global_alias'] is defined and not none %}
  {% for alias in hostvars[host]['global_alias'] %}{{ alias_list.append(alias) }}{% endfor %}
{% endif %}
{% if hostvars[host]['alias'] is defined and not none and host_icb == j2_current_iceberg %}
  {% for alias in hostvars[host]['alias'] %}{{ alias_list.append(alias) }}{% endfor %}
{% endif %}
{{write_host_2(host,hostvars[host]['network_interfaces'],hostvars[host]['j2_node_main_network_interface'],alias_list,hostvars[host]['bmc'])}}
{% endfor %}
#}

{% set main_host = hostvars[inventory_hostname] %}
{% for host in range %}
{% set host_icb = (macro_accelerated.node_current_iceberg(host)|trim) %}
{% set host_mg = (macro_accelerated.node_master_group(host)|trim) %}
{% set host_eqg = (macro_accelerated.node_equipment_group(host)|trim) %}
{% set host_definition = main_host[host_mg]['children'][host_eqg]['hosts'][host] %}
{% set host_nic = host_definition['network_interfaces'] %}
{% set host_bmc = host_definition['bmc'] %}
{% set host_icb_net = (management_networks_naming + (host_icb | replace(iceberg_naming,' ') | trim | string)) %}
{% set host_node_main_network = (macro_network.node_main_network(host_nic,host_icb_net) | trim) %}
{% set host_node_main_network_interface = (macro_network.node_main_network_interface(host_nic,host_node_main_network) | trim) %}
{% set alias_list = [] %}
{% if host_definition['global_alias'] is defined and not none %}
  {% for alias in host_definition['global_alias'] %}{{ alias_list.append(alias) }}{% endfor %}
{% endif %}
{% if host_definition['alias'] is defined and not none and host_icb == j2_current_iceberg %}
  {% for alias in host_definition['alias'] %}{{ alias_list.append(alias) }}{% endfor %}
{% endif %}
{{write_host_2(host,host_nic,host_node_main_network_interface,alias_list,host_bmc)}}
{% endfor %}

## External hosts

{% if external_hosts is defined and external_hosts is not none and external_hosts %}
{% for host in external_hosts %}
{{external_hosts[host]}} {{host}}
{% endfor %}
{% endif %}
